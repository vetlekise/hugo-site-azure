<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Build an automated reconciliation pipeline with GitHub Actions to periodically detect and correct Terraform drift.">
<title>Solve Terraform Drift</title>

<link rel='canonical' href='http://localhost:1313/post/terraform-drift-reconcile-pipeline/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="Solve Terraform Drift">
<meta property='og:description' content="Build an automated reconciliation pipeline with GitHub Actions to periodically detect and correct Terraform drift.">
<meta property='og:url' content='http://localhost:1313/post/terraform-drift-reconcile-pipeline/'>
<meta property='og:site_name' content='Vetle&#39;s Tech Chronicles'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Terraform' /><meta property='article:tag' content='GitHub Actions' /><meta property='article:published_time' content='2025-10-05T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2025-10-05T00:00:00&#43;00:00'/>
<meta name="twitter:title" content="Solve Terraform Drift">
<meta name="twitter:description" content="Build an automated reconciliation pipeline with GitHub Actions to periodically detect and correct Terraform drift.">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_325fee3f64c1ca66.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Vetle&#39;s Tech Chronicles</a></h1>
            <h2 class="site-description">A blog about technology, tutorials, and my thoughts.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/vetlekise'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://linkedin.com/in/vetlekise'
                        target="_blank"
                        title="LinkedIn"
                        rel="me"
                    >
                        
                        
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-linkedin"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 4m0 2a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2z"></path><path d="M8 11v5"></path><path d="M8 8v.01"></path><path d="M12 16v-5"></path><path d="M16 16v-3a2 2 0 00-4 0"></path></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#what-is-terraform-drift">What is Terraform Drift?</a></li>
    <li><a href="#applying-gitops-principals-to-infrastructure">Applying GitOps Principals to Infrastructure</a></li>
    <li><a href="#designing-the-reconciliation-pipeline">Designing the Reconciliation Pipeline</a></li>
    <li><a href="#building-the-pipeline-with-github-actions">Building the Pipeline with GitHub Actions</a></li>
    <li><a href="#best-practices-and-considerations">Best Practices and Considerations</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/how-to/" >
                How-To
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/terraform-drift-reconcile-pipeline/">Solve Terraform Drift</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            Build an automated reconciliation pipeline with GitHub Actions to periodically detect and correct Terraform drift.
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Oct 05, 2025</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    5 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="what-is-terraform-drift"><a href="#what-is-terraform-drift" class="header-anchor"></a>What is Terraform Drift?
</h2><p>Here&rsquo;s a description from the <a class="link" href="https://www.hashicorp.com/en/blog/detecting-and-managing-drift-with-terraform"  target="_blank" rel="noopener"
    >HashiCorp blog</a>:</p>
<blockquote>
<p><em>Drift is the term for when the real-world state of your infrastructure differs from the state defined in your configuration.</em></p></blockquote>
<p>It can be caused by many things, but urgent hotfixes and teams being unfamiliar with Infrastructure as Code (IaC) practices is the most likely cause. Its a significant problem because it undermines the core benefits of IaC.</p>
<p>The main issue is the loss of a single source of truth. When your code and infra tell different stories, you can no longer trust your code to be an accurate representation of your environment.</p>
<h2 id="applying-gitops-principals-to-infrastructure"><a href="#applying-gitops-principals-to-infrastructure" class="header-anchor"></a>Applying GitOps Principals to Infrastructure
</h2><p>This is where GitOps comes in. As <a class="link" href="https://about.gitlab.com/topics/gitops/"  target="_blank" rel="noopener"
    >GitLab</a> defines it:</p>
<blockquote>
<p><em>GitOps is an operational framework that takes DevOps best practices used for application development such as version control, collaboration, compliance, and CI/CD, and applies them to infrastructure automation.</em></p></blockquote>
<p>The core idea is simple:</p>
<ol>
<li><strong>Describe</strong> your entire desired infrastructure in a Git repository using declarative code.</li>
<li><strong>Automate</strong> the process that coninuously compares this desired state with the actual state of your live infrastructure.</li>
<li><strong>Correct</strong> any detected differences, ensuring the live environment always reflects the state defined in Git.</li>
</ol>
<p>By adopting this workflow, you treat your infrastructure the same as your application code. Changes are made via pull requests, reviewed by peers, and automatically deployed. This creates an audit trail and, most importantly, provides a mechanism for automatically correcting drift.</p>
<h2 id="designing-the-reconciliation-pipeline"><a href="#designing-the-reconciliation-pipeline" class="header-anchor"></a>Designing the Reconciliation Pipeline
</h2><p>To combat drift, we can build an automated reconciliation pipeline. This pipeline will periodically check for discrepancies and take action. Here&rsquo;s two approaches:</p>
<ol>
<li><strong>Detection-only</strong>
<ul>
<li>The pipeline runs <code>terraform plan</code> on a schedule. If it detects any differences, it doesn&rsquo;t apply them. Instead, it sends an alert to your team via Slack, creates a GitHub issue, or logs a warning. This approach is safer and gives your team full control over when and how to resolve the drift.</li>
</ul>
</li>
<li><strong>Auto-correction</strong>
<ul>
<li>This is the full GitOps approach. The pipeline runs <code>terraform plan</code> to detect drift and, if any is found, immediately runs <code>terraform apply</code> to automatically revert the infrastructure to the state defined in your code. This ensures your infrastructure is always in sync, but this requires a high degree of confidence in your automation and testing.</li>
</ul>
</li>
</ol>
<h2 id="building-the-pipeline-with-github-actions"><a href="#building-the-pipeline-with-github-actions" class="header-anchor"></a>Building the Pipeline with GitHub Actions
</h2><p>Our goal is to create the <strong>auto-correction</strong> pipeline that runs on a schedule, checks for drift, and automatically applies the correct config if any drift is found.</p>
<p>Create a new file in your repository at <code>.github/workflows/terraform-reconcile.yml</code> and add the following code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Terraform Drift Reconciliation&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Allows you to run this workflow manually from the Actions tab</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">workflow_dispatch</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Runs on a schedule (e.g., every day at 2:00 AM UTC)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">cron</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;0 2 * * *&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">terraform-reconcile</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Terraform Reconcile&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Checkout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/checkout@v5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Setup Terraform</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">hashicorp/setup-terraform@v3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># ... Add step for authenticating to provider</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Terraform Init</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">init</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">terraform init</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Terraform Plan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">continue-on-error</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">plan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">          plan_output=$(terraform plan -no-color -out=tfplan 2&gt;&amp;1)
</span></span></span><span class="line"><span class="cl"><span class="sd">          echo &#34;${plan_output}&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">          
</span></span></span><span class="line"><span class="cl"><span class="sd">          echo &#34;drift_detected=false&#34; &gt;&gt; $GITHUB_OUTPUT
</span></span></span><span class="line"><span class="cl"><span class="sd">          
</span></span></span><span class="line"><span class="cl"><span class="sd">          echo &#34;plan_text&lt;&lt;EOF&#34; &gt;&gt; $GITHUB_OUTPUT
</span></span></span><span class="line"><span class="cl"><span class="sd">          echo &#34;${plan_output}&#34; &gt;&gt; $GITHUB_OUTPUT
</span></span></span><span class="line"><span class="cl"><span class="sd">          echo &#34;EOF&#34; &gt;&gt; $GITHUB_OUTPUT
</span></span></span><span class="line"><span class="cl"><span class="sd">          
</span></span></span><span class="line"><span class="cl"><span class="sd">          if echo &#34;${plan_output}&#34; | grep -q &#39;Plan:&#39;; then
</span></span></span><span class="line"><span class="cl"><span class="sd">            if ! echo &#34;${plan_output}&#34; | grep -q &#39;No changes.&#39;; then
</span></span></span><span class="line"><span class="cl"><span class="sd">              echo &#34;Drift detected. Setting drift_detected=true&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">              echo &#34;drift_detected=true&#34; &gt;&gt; $GITHUB_OUTPUT
</span></span></span><span class="line"><span class="cl"><span class="sd">            fi
</span></span></span><span class="line"><span class="cl"><span class="sd">          fi
</span></span></span><span class="line"><span class="cl"><span class="sd">          
</span></span></span><span class="line"><span class="cl"><span class="sd">          if ! echo &#34;${plan_output}&#34; | grep -q -e &#39;Plan:&#39; -e &#39;No changes.&#39;; then
</span></span></span><span class="line"><span class="cl"><span class="sd">            echo &#34;::error::Terraform plan failed with an error.&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">            exit 1
</span></span></span><span class="line"><span class="cl"><span class="sd">          fi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Terraform Apply</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">steps.plan.outputs.drift_detected == &#39;true&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">terraform apply -auto-approve &#34;tfplan&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Post Summary - Drift Found</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">steps.plan.outputs.drift_detected == &#39;true&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">PLAN_TEXT</span><span class="p">:</span><span class="w"> </span><span class="l">${{ steps.plan.outputs.plan_text }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">          echo &#34;## Terraform Drift Reconciliation Report&#34; &gt;&gt; $GITHUB_STEP_SUMMARY
</span></span></span><span class="line"><span class="cl"><span class="sd">          echo &#34;Drift was detected and automatically corrected at $(date).&#34; &gt;&gt; $GITHUB_STEP_SUMMARY
</span></span></span><span class="line"><span class="cl"><span class="sd">          echo &#34;&#34; &gt;&gt; $GITHUB_STEP_SUMMARY
</span></span></span><span class="line"><span class="cl"><span class="sd">          echo &#34;&lt;details&gt;&lt;summary&gt;View Terraform Plan&lt;/summary&gt;&#34; &gt;&gt; $GITHUB_STEP_SUMMARY
</span></span></span><span class="line"><span class="cl"><span class="sd">          echo &#34;&#34; &gt;&gt; $GITHUB_STEP_SUMMARY
</span></span></span><span class="line"><span class="cl"><span class="sd">          echo &#39;```terraform&#39; &gt;&gt; $GITHUB_STEP_SUMMARY
</span></span></span><span class="line"><span class="cl"><span class="sd">          echo &#34;$PLAN_TEXT&#34; &gt;&gt; $GITHUB_STEP_SUMMARY
</span></span></span><span class="line"><span class="cl"><span class="sd">          echo &#39;```&#39; &gt;&gt; $GITHUB_STEP_SUMMARY
</span></span></span><span class="line"><span class="cl"><span class="sd">          echo &#34;&lt;/details&gt;&#34; &gt;&gt; $GITHUB_STEP_SUMMARY
</span></span></span><span class="line"><span class="cl"><span class="sd">          </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Post Summary - Drift Not Found</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">steps.plan.outputs.drift_detected == &#39;false&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">          echo &#34;## Terraform Drift Reconciliation Report&#34; &gt;&gt; $GITHUB_STEP_SUMMARY
</span></span></span><span class="line"><span class="cl"><span class="sd">          echo &#34;No infrastructure drift was detected at $(date).&#34; &gt;&gt; $GITHUB_STEP_SUMMARY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Post Summary - Plan Error</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">steps.plan.outcome == &#39;failure&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">          echo &#34;## Terraform Drift Reconciliation Report&#34; &gt;&gt; $GITHUB_STEP_SUMMARY
</span></span></span><span class="line"><span class="cl"><span class="sd">          echo &#34;The Terraform plan step failed with an error. Please check the logs for details.&#34; &gt;&gt; $GITHUB_STEP_SUMMARY</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>This workflow builds a custom output (<code>steps.plan.outputs.drift_detected</code>) during the <code>plan</code> step that is used by the other steps.</p>
<p>I tried using the <a class="link" href="https://developer.hashicorp.com/terraform/cli/commands/plan#detailed-exitcode"  target="_blank" rel="noopener"
    >-detailed-exitcode</a> flag for <code>terraform plan</code> in combination with conditionals for posting summaries, but GitHub Actions must have some sort of bug, because it didn&rsquo;t output the correct exit codes.</p>
<p><img src="/post/terraform-drift-reconcile-pipeline/drift-detected.png"
	width="2220"
	height="1012"
	srcset="/post/terraform-drift-reconcile-pipeline/drift-detected_hu_4b2624ad98dfaae2.png 480w, /post/terraform-drift-reconcile-pipeline/drift-detected_hu_462a0505414c0235.png 1024w"
	loading="lazy"
	
		alt="Drift detected"
	
	
		class="gallery-image" 
		data-flex-grow="219"
		data-flex-basis="526px"
	
>
<img src="/post/terraform-drift-reconcile-pipeline/no-drift.png"
	width="2238"
	height="924"
	srcset="/post/terraform-drift-reconcile-pipeline/no-drift_hu_a14daf74a4894dd8.png 480w, /post/terraform-drift-reconcile-pipeline/no-drift_hu_283bf0c9ba855969.png 1024w"
	loading="lazy"
	
		alt="No drift detected"
	
	
		class="gallery-image" 
		data-flex-grow="242"
		data-flex-basis="581px"
	
>
<img src="/post/terraform-drift-reconcile-pipeline/drift-error.png"
	width="2218"
	height="926"
	srcset="/post/terraform-drift-reconcile-pipeline/drift-error_hu_9051e470b1fa59b4.png 480w, /post/terraform-drift-reconcile-pipeline/drift-error_hu_b750092de07c9f2b.png 1024w"
	loading="lazy"
	
		alt="Error during plan"
	
	
		class="gallery-image" 
		data-flex-grow="239"
		data-flex-basis="574px"
	
></p>
<h2 id="best-practices-and-considerations"><a href="#best-practices-and-considerations" class="header-anchor"></a>Best Practices and Considerations
</h2><p>Before deploying this in a production environment, consider the following:</p>
<ul>
<li><strong>Start with</strong> <code>detection-only</code>
<ul>
<li>Begin by removing the <code>terraform apply</code> step and adding a notification step instead. Let the pipeline run for a while to see how often drift occurs.</li>
</ul>
</li>
<li><strong>Limit scope</strong>
<ul>
<li>Initially, run this pipeline only on non-critical environments, like development.</li>
</ul>
</li>
<li><strong>Secure your credentials</strong>
<ul>
<li>OIDC is the most secure way to authenticate with your provider, as it provides short-lived, automatically rotating credentials.</li>
</ul>
</li>
<li><strong>Use notifications</strong>
<ul>
<li>Even with auto-correction, you can still notify your team when drift is detected and corrected. Consider adding a step to send a message to a Slack channel to keep everyone informed.</li>
</ul>
</li>
<li><strong>Role-based access control (RBAC)</strong>
<ul>
<li>The user that did a manual change (ClickOps), do they really need permission to do so?</li>
</ul>
</li>
</ul>
<h2 id="conclusion"><a href="#conclusion" class="header-anchor"></a>Conclusion
</h2><p>Drift is natural when managing complex systems, expecially in immature environments where processes haven&rsquo;t been fully developed. By implementing an automated reconciliation pipeline, you eliminate configuration drift, and create a more stable and predictable environment. It&rsquo;s a good step towards a mature environment.</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/terraform/">Terraform</a>
        
            <a href="/tags/github-actions/">GitHub Actions</a>
        
    </section>


    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/post/multi-environment-terraform/">
        
        

        <div class="article-details">
            <h2 class="article-title">Manage Multiple Terraform Environments</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/post/azure-terraform-github-actions-oidc/">
        
        

        <div class="article-details">
            <h2 class="article-title">Eliminate Secrets From Your Terraform Azure Backend</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/post/hugo-site-azure/">
        
        

        <div class="article-details">
            <h2 class="article-title">Build a Hugo Website on Azure</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/post/develop-terraform-modules/">
        
        

        <div class="article-details">
            <h2 class="article-title">Develop Terraform Modules</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/post/genai-certification-study/">
        
        

        <div class="article-details">
            <h2 class="article-title">Study With Generative AI</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 Vetle&#39;s Tech Chronicles
    </section>
    
    <section class="powerby">
        
            All opinions are my own. <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.31.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.e37a1c77e9f793cd8619172a944d78c1066956c7d5cd59e9bd51bd3e348898ea.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
