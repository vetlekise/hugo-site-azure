<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="A deep dive into managing multiple environments in Infrastructure as Code with Terraform, OpenTofu, and Terragrunt.">
<title>Manage Multiple Terraform Environments</title>

<link rel='canonical' href='http://localhost:1313/post/multi-environment-terraform/'>

<link rel="stylesheet" href="/scss/style.min.11f3a414f6185c76b6bf50d343d6c2f7cd8139b8adcdbba0bd48cb9f25af8f2d.css"><meta property='og:title' content="Manage Multiple Terraform Environments">
<meta property='og:description' content="A deep dive into managing multiple environments in Infrastructure as Code with Terraform, OpenTofu, and Terragrunt.">
<meta property='og:url' content='http://localhost:1313/post/multi-environment-terraform/'>
<meta property='og:site_name' content='Vetle&#39;s Tech Chronicles'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Terraform' /><meta property='article:tag' content='OpenTofu' /><meta property='article:tag' content='Terragrunt' /><meta property='article:tag' content='GitHub Actions' /><meta property='article:tag' content='IaC' /><meta property='article:published_time' content='2025-10-10T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2025-10-10T00:00:00&#43;00:00'/>
<meta name="twitter:title" content="Manage Multiple Terraform Environments">
<meta name="twitter:description" content="A deep dive into managing multiple environments in Infrastructure as Code with Terraform, OpenTofu, and Terragrunt.">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_325fee3f64c1ca66.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Vetle&#39;s Tech Chronicles</a></h1>
            <h2 class="site-description">A blog about technology, tutorials, and my thoughts.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/vetlekise'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://linkedin.com/in/vetlekise'
                        target="_blank"
                        title="LinkedIn"
                        rel="me"
                    >
                        
                        
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-linkedin"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 4m0 2a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2z"></path><path d="M8 11v5"></path><path d="M8 8v.01"></path><path d="M12 16v-5"></path><path d="M16 16v-3a2 2 0 00-4 0"></path></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#isolated-folders">Isolated Folders</a>
      <ul>
        <li><a href="#pros">Pros</a></li>
        <li><a href="#cons">Cons</a></li>
        <li><a href="#project-structure">Project Structure</a></li>
        <li><a href="#configuration-examples">Configuration Examples</a></li>
        <li><a href="#local-workflow">Local Workflow</a></li>
        <li><a href="#cicd-pipeline-github-actions">CI/CD Pipeline (GitHub Actions)</a></li>
      </ul>
    </li>
    <li><a href="#opentofu-workspaces">OpenTofu Workspaces</a>
      <ul>
        <li><a href="#pros-1">Pros</a></li>
        <li><a href="#cons-1">Cons</a></li>
        <li><a href="#project-structure-1">Project Structure</a></li>
        <li><a href="#configuration-examples-1">Configuration Examples</a></li>
        <li><a href="#local-workflow-1">Local Workflow</a></li>
        <li><a href="#cicd-pipeline-github-actions-1">CI/CD Pipeline (GitHub Actions)</a></li>
      </ul>
    </li>
    <li><a href="#terragrunt-explicit-stacks">Terragrunt Explicit Stacks</a>
      <ul>
        <li><a href="#pros-2">Pros</a></li>
        <li><a href="#cons-2">Cons</a></li>
        <li><a href="#project-structure-2">Project Structure</a></li>
        <li><a href="#configuration-examples-2">Configuration Examples</a></li>
        <li><a href="#local-workflow-2">Local Workflow</a></li>
        <li><a href="#cicd-pipeline-github-actions-2">CI/CD Pipeline (GitHub Actions)</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#resources--links">Resources &amp; Links</a></li>
  </ul>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/how-to/" >
                How-To
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/multi-environment-terraform/">Manage Multiple Terraform Environments</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            A deep dive into managing multiple environments in Infrastructure as Code with Terraform, OpenTofu, and Terragrunt.
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Oct 10, 2025</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    18 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="introduction"><a href="#introduction" class="header-anchor"></a>Introduction
</h2><p>Every project starts simple, but when managing infrastructure for <code>dev</code>, <code>test</code>, and <code>prod</code>, let alone multiple customers, it quickly becomes complex. How can we solve this chaos?</p>
<p>We&rsquo;ll tackle the common issues of scalable IaC, and go through a clear journey from basic patterns to something more advanced, showing you how to choose the right tool for the job.</p>
<h2 id="isolated-folders"><a href="#isolated-folders" class="header-anchor"></a>Isolated Folders
</h2><p>This is the classic starting point when trying to figure out multi-environment setups. Its the simplest way to manage multiple environments by giving each one its own dedicated directory.</p>
<h3 id="pros"><a href="#pros" class="header-anchor"></a>Pros
</h3><ul>
<li>Each environment has its own dedicated directory and state file, providing the highest level of safety and preventing accidental cross-environment changes.</li>
<li>The structure is straightforward and very easy to understand, making it an excellent starting point for new projects or teams.</li>
<li>The logic is intuitive, which is ideal for those new to Infrastructure as Code (IaC).</li>
</ul>
<h3 id="cons"><a href="#cons" class="header-anchor"></a>Cons
</h3><ul>
<li>You must repeat boilerplate code (like providers and variables) for each environment, which violates the Don&rsquo;t Repeat Yourself (DRY) principle.</li>
<li>As the project grows, making a change to a shared component requires updating it in every single folder, which is tedious and error-prone.</li>
<li>This pattern quickly becomes unmanageable and inefficient when dealing with a large number of environments.</li>
</ul>
<h3 id="project-structure"><a href="#project-structure" class="header-anchor"></a>Project Structure
</h3><p>Your repository will typically be organized into <code>dev</code>, <code>test</code>, and <code>prod</code> directories. Each environment then calls the modules from versioned repositories.</p>

  <blockquote>
    <p><strong>Note</strong>: Instead of using separate repositories for your modules, you could create a <code>modules</code> directory. Problem with this is versioning and its difficult for others to reuse your module.</p>
  </blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">application</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">dev</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">├──</span> <span class="n">main</span><span class="o">.</span><span class="n">tf</span>           <span class="c1"># Calls the versioned &#39;core-infra&#39;</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">├──</span> <span class="n">variables</span><span class="o">.</span><span class="n">tf</span>      <span class="c1"># Declares variables for the dev environment</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">└──</span> <span class="n">terraform</span><span class="o">.</span><span class="n">tfvars</span>  <span class="c1"># Assigns values for dev</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>
</span></span><span class="line"><span class="cl"><span class="err">└──</span> <span class="n">prod</span><span class="o">/</span>
</span></span><span class="line"><span class="cl">    <span class="err">├──</span> <span class="n">main</span><span class="o">.</span><span class="n">tf</span>
</span></span><span class="line"><span class="cl">    <span class="err">├──</span> <span class="n">variables</span><span class="o">.</span><span class="n">tf</span>
</span></span><span class="line"><span class="cl">    <span class="err">└──</span> <span class="n">terraform</span><span class="o">.</span><span class="n">tfvars</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="configuration-examples"><a href="#configuration-examples" class="header-anchor"></a>Configuration Examples
</h3><p>Let&rsquo;s say you have another repository acting as a Terraform module called <code>core-infra</code> and you want this deployed to the <code>dev</code> environment. This module has its own <code>variables.tf</code> with variable declarations (aka. input parameters). You then declare the required variables in your application repo <code>dev/variables.tf</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-terraform" data-lang="terraform"><span class="line"><span class="cl"><span class="kr">variable</span> <span class="s2">&#34;vm_count&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">description</span> <span class="o">=</span> <span class="s2">&#34;Number of Azure Virtual Machines.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">number</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">variable</span> <span class="s2">&#34;vm_size&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">description</span> <span class="o">=</span> <span class="s2">&#34;The Azure VM size.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">variable</span> <span class="s2">&#34;location&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">description</span> <span class="o">=</span> <span class="s2">&#34;The Azure region where resources will be deployed.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is where the duplicate code comes in. You&rsquo;ve now declared variables in <code>dev/variables.tf</code>, but now you want to deploy the same module to the <code>prod</code> environment, so now you have to duplicate the variables in <code>prod/variables.tf</code></p>
<p>To provide values to the variables you add the following to <code>dev/terraform.tfvars</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-terraform" data-lang="terraform"><span class="line"><span class="cl"><span class="nx">vm_count</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nx">vm_size</span>  <span class="o">=</span> <span class="s2">&#34;Standard_B1s&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">location</span> <span class="o">=</span> <span class="s2">&#34;Norway East&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In <code>dev/main.tf</code> is where you would call your reusable module <code>core-infra</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-terraform" data-lang="terraform"><span class="line"><span class="cl"><span class="kr">module</span> <span class="s2">&#34;core_infra&#34;</span> <span class="p">{</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">  # Source points to a separate Git repo and a specific version tag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">source</span> <span class="o">=</span> <span class="s2">&#34;git@github.com:your-org/core-infra.git?ref=v1.0.0&#34;</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">  # Pass values to the module
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">environment</span> <span class="o">=</span> <span class="s2">&#34;dev&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">vm_count</span>    <span class="o">=</span> <span class="nb">var</span><span class="p">.</span><span class="nx">vm_count</span>
</span></span><span class="line"><span class="cl">  <span class="nx">vm_size</span>     <span class="o">=</span> <span class="nb">var</span><span class="p">.</span><span class="nx">vm_size</span>
</span></span><span class="line"><span class="cl">  <span class="nx">location</span>    <span class="o">=</span> <span class="nb">var</span><span class="p">.</span><span class="nx">location</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Why not hardcode all the values in the module call you ask?</p>
<p>A <code>.tfvars</code> file acts as a clean, simple <em>input sheet</em> for an environment. Someone less familiar with Terraform would immediately see all the key parameters instead of needing to look in the configuration files. You can also easily override them using <code>terraform apply -var=&quot;location=westeurope&quot;</code> which makes automation easier.</p>
<h3 id="local-workflow"><a href="#local-workflow" class="header-anchor"></a>Local Workflow
</h3><p>To deploy the <code>dev</code> environment, navigate into its folder within the <code>application</code> repo and apply the configuration:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 1. Clone the live application repo and change into it</span>
</span></span><span class="line"><span class="cl">git clone git@github.com:your-org/application.git
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> application/dev
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 2. Initialize Terraform (this will download the module from Git)</span>
</span></span><span class="line"><span class="cl">terraform init
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 3. Plan and Apply</span>
</span></span><span class="line"><span class="cl">terraform plan
</span></span><span class="line"><span class="cl">terraform apply
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="cicd-pipeline-github-actions"><a href="#cicd-pipeline-github-actions" class="header-anchor"></a>CI/CD Pipeline (GitHub Actions)
</h3><p>The following workflow example is dynamic. It looks at the changed environments and builds a matrix to dynamically run plan and apply to the correct environment.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Terraform Folders&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">types</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">opened, synchronize, reopened]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">main]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s1">&#39;dev/**&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s1">&#39;prod/**&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">push</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">main]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s1">&#39;dev/**&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s1">&#39;prod/**&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Add permissions for writing PR comments.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># You may need to add more permissions here for your cloud provider&#39;s OIDC.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">permissions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pull-requests</span><span class="p">:</span><span class="w"> </span><span class="l">write</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Example for OIDC:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># id-token: write</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># contents: read</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">detect-changes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Detect Changed Environments&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">outputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">environments</span><span class="p">:</span><span class="w"> </span><span class="l">${{ steps.filter.outputs.all_changed_files }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Checkout Code&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/checkout@v5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">fetch-depth</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Find changed environment folders&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">filter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">tj-actions/changed-files@v44</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c"># Since dev/prod are in root, the base path is the repository root</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">dir_names</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">json</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">escape_json</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c"># Define the environment folders to watch for changes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">files</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">            dev/**
</span></span></span><span class="line"><span class="cl"><span class="sd">            prod/**</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Debug Output&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">            echo &#34;Detected changes: ${{ steps.filter.outputs.all_changed_files }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">plan</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Plan for ${{ matrix.environment }}&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">needs</span><span class="p">:</span><span class="w"> </span><span class="l">detect-changes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">needs.detect-changes.outputs.environments != &#39;[]&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matrix</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">${{ fromJson(needs.detect-changes.outputs.environments) }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Checkout Code&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/checkout@v5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Setup Terraform&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">hashicorp/setup-terraform@v3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Add your cloud provider login step here.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Terraform Init&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">init</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">working-directory</span><span class="p">:</span><span class="w"> </span><span class="l">${{ matrix.environment }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">terraform init -no-color</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Terraform Plan&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">plan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">working-directory</span><span class="p">:</span><span class="w"> </span><span class="l">${{ matrix.environment }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">terraform plan -no-color -out=tfplan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Upload Plan Artifact&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/upload-artifact@v4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tfplan-${{ matrix.environment }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">${{ matrix.environment }}/tfplan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Post Plan Comment to PR</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">steps.plan.outcome == &#39;success&#39; &amp;&amp; github.event_name == &#39;pull_request&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/github-script@v8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">PLAN</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;${{ steps.plan.outputs.stdout }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">            const { PLAN } = process.env;
</span></span></span><span class="line"><span class="cl"><span class="sd">            
</span></span></span><span class="line"><span class="cl"><span class="sd">            const output = `#### Terraform Plan for \`${{ matrix.environment }}\`
</span></span></span><span class="line"><span class="cl"><span class="sd">            &lt;details&gt;&lt;summary&gt;Show Plan&lt;/summary&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">            
</span></span></span><span class="line"><span class="cl"><span class="sd">            \`\`\`terraform
</span></span></span><span class="line"><span class="cl"><span class="sd">            ${PLAN}
</span></span></span><span class="line"><span class="cl"><span class="sd">            \`\`\`
</span></span></span><span class="line"><span class="cl"><span class="sd">            
</span></span></span><span class="line"><span class="cl"><span class="sd">            &lt;/details&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">            
</span></span></span><span class="line"><span class="cl"><span class="sd">            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
</span></span></span><span class="line"><span class="cl"><span class="sd">            
</span></span></span><span class="line"><span class="cl"><span class="sd">            await github.rest.issues.createComment({
</span></span></span><span class="line"><span class="cl"><span class="sd">              owner: context.repo.owner,
</span></span></span><span class="line"><span class="cl"><span class="sd">              repo: context.repo.repo,
</span></span></span><span class="line"><span class="cl"><span class="sd">              issue_number: context.issue.number,
</span></span></span><span class="line"><span class="cl"><span class="sd">              body: output
</span></span></span><span class="line"><span class="cl"><span class="sd">            });</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apply</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Apply for ${{ matrix.environment }}&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">needs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">detect-changes, plan]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">github.event_name == &#39;push&#39; &amp;&amp; github.ref == &#39;refs/heads/main&#39; &amp;&amp; needs.detect-changes.outputs.environments != &#39;[]&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">matrix</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">${{ fromJson(needs.detect-changes.outputs.environments) }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Checkout Code&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/checkout@v5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Setup Terraform&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">hashicorp/setup-terraform@v3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Add your cloud provider login step here (same as in the plan job).</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Download Plan Artifact&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/download-artifact@v5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tfplan-${{ matrix.environment }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">${{ matrix.environment }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Terraform Init&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">init</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">working-directory</span><span class="p">:</span><span class="w"> </span><span class="l">${{ matrix.environment }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">terraform init -no-color</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Terraform Apply&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">apply</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">working-directory</span><span class="p">:</span><span class="w"> </span><span class="l">${{ matrix.environment }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">terraform apply -auto-approve &#34;tfplan&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/multi-environment-terraform/folders-pr.png"
	width="1830"
	height="918"
	srcset="/post/multi-environment-terraform/folders-pr_hu_1d8f026a4a53a82.png 480w, /post/multi-environment-terraform/folders-pr_hu_236411a98ce93200.png 1024w"
	loading="lazy"
	
		alt="Comments in pull requests"
	
	
		class="gallery-image" 
		data-flex-grow="199"
		data-flex-basis="478px"
	
>
<img src="/post/multi-environment-terraform/folders-merge.png"
	width="2248"
	height="1118"
	srcset="/post/multi-environment-terraform/folders-merge_hu_d0bc13449246cbdf.png 480w, /post/multi-environment-terraform/folders-merge_hu_ed1208e333f5a103.png 1024w"
	loading="lazy"
	
		alt="Completed pull request"
	
	
		class="gallery-image" 
		data-flex-grow="201"
		data-flex-basis="482px"
	
></p>
<h2 id="opentofu-workspaces"><a href="#opentofu-workspaces" class="header-anchor"></a>OpenTofu Workspaces
</h2><p>Terraform has a feature called <a class="link" href="https://developer.hashicorp.com/terraform/language/state/workspaces"  target="_blank" rel="noopener"
    >Workspaces</a> that&rsquo;s used to deploy the same code to multiple environments, keeping your configuration DRY. It still uses one backend but creates separate states for better isolation.</p>
<p>While Terraform workspaces <em>work</em>, we are going to leverage an exclusive OpenTofu feature <code>early variable evaluation</code> to make our lives easier.</p>
<p><strong>FAILS</strong> in Terraform:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-terraform" data-lang="terraform"><span class="line"><span class="cl"><span class="c1"># You cannot enable or disable a module based on the workspace.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">module</span> <span class="s2">&#34;monitoring_alerts&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">source</span> <span class="o">=</span> <span class="s2">&#34;./modules/monitoring&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nb">count</span>  <span class="o">=</span> <span class="nx">terraform</span><span class="p">.</span><span class="nx">workspace</span> <span class="o">==</span> <span class="s2">&#34;prod&#34;</span> <span class="o">?</span> <span class="m">1</span> <span class="o">:</span> <span class="m">0</span><span class="c1"> # ERROR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>WORKS</strong> in OpenTofu:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-terraform" data-lang="terraform"><span class="line"><span class="cl"><span class="c1"># You can enable or disable a modules based on the workspace.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">module</span> <span class="s2">&#34;monitoring_alerts&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">source</span> <span class="o">=</span> <span class="s2">&#34;./modules/monitoring&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nb">count</span>  <span class="o">=</span> <span class="nx">tofu</span><span class="p">.</span><span class="nx">workspace</span> <span class="o">==</span> <span class="s2">&#34;prod&#34;</span> <span class="o">?</span> <span class="m">1</span> <span class="o">:</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="pros-1"><a href="#pros-1" class="header-anchor"></a>Pros
</h3><ul>
<li>It keeps your codebase clean by using a single set of configuration files for all environments, eliminating boilerplate code.</li>
<li>Workspaces provide a safe way to manage separate state files for each environment while using the same backend configuration.</li>
<li>You can efficiently manage a single application or service across multiple similar environments from one place.</li>
</ul>
<h3 id="cons-1"><a href="#cons-1" class="header-anchor"></a>Cons
</h3><ul>
<li>As environments diverge, the code can become cluttered with complex conditional logic (<code>count</code>, <code>for_each</code>), making it hard to read and maintain.</li>
<li>A mistake in the single codebase can potentially affect all environments, as they are not fully isolated at the code level.</li>
<li>The pattern is less suitable for managing vastly different environments, as forcing all variations into one set of files leads to overly complicated configurations.</li>
</ul>
<h3 id="project-structure-1"><a href="#project-structure-1" class="header-anchor"></a>Project Structure
</h3><p>With workspaces, your directory structure becomes quite simple. All your config for the application lives in a single folder:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">application</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">main</span><span class="o">.</span><span class="n">tf</span>              <span class="c1"># The main logic.</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">variables</span><span class="o">.</span><span class="n">tf</span>         <span class="c1"># A SINGLE declaration of all variables</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">dev</span><span class="o">.</span><span class="n">tfvars</span>           <span class="c1"># Values for the &#39;dev&#39; environment</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">prod</span><span class="o">.</span><span class="n">tfvars</span>          <span class="c1"># Values for the &#39;prod&#39; environment</span>
</span></span><span class="line"><span class="cl"><span class="err">└──</span> <span class="n">backend</span><span class="o">.</span><span class="n">tf</span>           <span class="c1"># Defines the remote state backend</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
  <blockquote>
    <p><strong>Note</strong>: Example above only uses a main.tf file, but there&rsquo;s nothing stopping you from creating more configurations!</p>
  </blockquote>
<h3 id="configuration-examples-1"><a href="#configuration-examples-1" class="header-anchor"></a>Configuration Examples
</h3><p><code>variables.tf</code></p>
<p>Variables are declared only once.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-terraform" data-lang="terraform"><span class="line"><span class="cl"><span class="kr">variable</span> <span class="s2">&#34;vm_count&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">description</span> <span class="o">=</span> <span class="s2">&#34;The number of Azure Virtual Machines.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">number</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">variable</span> <span class="s2">&#34;vm_size&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">description</span> <span class="o">=</span> <span class="s2">&#34;The Azure VM size (e.g., &#39;Standard_B1s&#39;).&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">variable</span> <span class="s2">&#34;location&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">description</span> <span class="o">=</span> <span class="s2">&#34;The Azure region where resources will be deployed.&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">type</span>        <span class="o">=</span> <span class="nx">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>&lt;insert_env&gt;.tfvars</code></p>
<p>Provides specific values for each environment.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-terraform" data-lang="terraform"><span class="line"><span class="cl"><span class="nx">vm_count</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nx">vm_size</span> <span class="o">=</span> <span class="s2">&#34;Standard_B1s&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">location</span> <span class="o">=</span> <span class="s2">&#34;Norway East&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>main.tf</code></p>
<p>Handle resource creation with conditionals.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-terraform" data-lang="terraform"><span class="line"><span class="cl"><span class="c1"># This main module is enabled for all workspaces
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">module</span> <span class="s2">&#34;core_infra&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">source</span> <span class="o">=</span> <span class="s2">&#34;git@github.com:your-org/core-infra.git?ref=v1.0.0&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">vm_count</span>    <span class="o">=</span> <span class="nb">var</span><span class="p">.</span><span class="nx">vm_count</span>
</span></span><span class="line"><span class="cl">  <span class="nx">vm_size</span>     <span class="o">=</span> <span class="nb">var</span><span class="p">.</span><span class="nx">vm_size</span>
</span></span><span class="line"><span class="cl">  <span class="nx">location</span>    <span class="o">=</span> <span class="nb">var</span><span class="p">.</span><span class="nx">location</span>
</span></span><span class="line"><span class="cl">  <span class="nx">environment</span> <span class="o">=</span> <span class="nx">tofu</span><span class="p">.</span><span class="nx">workspace</span><span class="c1"> # The workspace name is used to tag resources
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1"># The monitoring module is conditionally enabled only in the &#39;prod&#39; environment
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">module</span> <span class="s2">&#34;monitoring_alerts&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">source</span> <span class="o">=</span> <span class="s2">&#34;git@github.com:your-org/monitoring-alerts.git?ref=v1.2.0&#34;</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">  
</span></span></span><span class="line"><span class="cl"><span class="c1">  # This works perfectly in OpenTofu, allowing dynamic environments
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nb">count</span>  <span class="o">=</span> <span class="nx">tofu</span><span class="p">.</span><span class="nx">workspace</span> <span class="o">==</span> <span class="s2">&#34;prod&#34;</span> <span class="o">?</span> <span class="m">1</span> <span class="o">:</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="local-workflow-1"><a href="#local-workflow-1" class="header-anchor"></a>Local Workflow
</h3><p>The workflow involves selecting the correct workspace context before applying.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 1. Clone the application repo and change into it</span>
</span></span><span class="line"><span class="cl">git clone git@github.com:your-org/application.git
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> application
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 2. Initialize OpenTofu (this will download the module from Git)</span>
</span></span><span class="line"><span class="cl">tofu init
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 3. Create workspaces</span>
</span></span><span class="line"><span class="cl">tofu workspace new dev
</span></span><span class="line"><span class="cl">tofu workspace new prod
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 4. Deploy to &#39;dev&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 4.1 Switch to the &#39;dev&#39; workspace</span>
</span></span><span class="line"><span class="cl">tofu workspace <span class="k">select</span> dev
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 4.2 Plan and apply, specifying the correct .tfvars file</span>
</span></span><span class="line"><span class="cl">tofu plan -var-file<span class="o">=</span><span class="s2">&#34;dev.tfvars&#34;</span>
</span></span><span class="line"><span class="cl">tofu apply -var-file<span class="o">=</span><span class="s2">&#34;dev.tfvars&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="cicd-pipeline-github-actions-1"><a href="#cicd-pipeline-github-actions-1" class="header-anchor"></a>CI/CD Pipeline (GitHub Actions)
</h3><p>This pipeline uses a GitHub Actions feature called <strong>reusable workflows</strong> to keep your pipeline DRY and easy to manage. The logic is split into two files: a reusable <strong>worker</strong> that performs the deployment, and a main <strong>orchestrator</strong> that defines the release process.</p>
<p><code>reusable-worker.yml</code></p>
<p>Contains all the steps to deploy to any single environment. It accepts an <code>environment</code> name as an input, which it uses to dynamically select the correct OpenTofu workspace and <code>tfvars</code> file. This means you only have to define your deployment logic once.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Tofu Reusable Worker&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">workflow_call</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">plan_only</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">boolean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">permissions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">id-token</span><span class="p">:</span><span class="w"> </span><span class="l">write</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">contents</span><span class="p">:</span><span class="w"> </span><span class="l">read</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pull-requests</span><span class="p">:</span><span class="w"> </span><span class="l">write</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tofu</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Tofu ${{ inputs.plan_only &amp;&amp; &#39;Plan&#39; || &#39;Apply&#39; }} on ${{ inputs.environment }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">${{ inputs.environment }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Checkout Code&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/checkout@v4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Setup OpenTofu&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">opentofu/setup-opentofu@v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Add your cloud provider login here.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Tofu Init&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">tofu init</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Select or Create Workspace&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">tofu workspace select -or-create ${{ inputs.environment }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Tofu Validate&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">tofu validate -no-color</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Tofu Plan&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">plan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">tofu plan -var-file=&#34;${{ inputs.environment }}.tfvars&#34; -no-color -out=tfplan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">continue-on-error</span><span class="p">:</span><span class="w"> </span><span class="l">${{ inputs.plan_only }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Post Plan Comment to PR&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">inputs.plan_only &amp;&amp; github.event_name == &#39;pull_request&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/github-script@v7</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">PLAN</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;tofu\n${{ steps.plan.outputs.stdout }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">            const { PLAN } = process.env;
</span></span></span><span class="line"><span class="cl"><span class="sd">            const output = `#### OpenTofu Plan 📖 \`${{ github.event.pull_request.head.sha }}\` for \`${{ inputs.environment }}\`
</span></span></span><span class="line"><span class="cl"><span class="sd">            &lt;details&gt;&lt;summary&gt;Show Plan&lt;/summary&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">            \`\`\`\n${PLAN}\n\`\`\`
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">            &lt;/details&gt;
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">            await github.rest.issues.createComment({
</span></span></span><span class="line"><span class="cl"><span class="sd">              owner: context.repo.owner,
</span></span></span><span class="line"><span class="cl"><span class="sd">              repo: context.repo.repo,
</span></span></span><span class="line"><span class="cl"><span class="sd">              issue_number: context.issue.number,
</span></span></span><span class="line"><span class="cl"><span class="sd">              body: output
</span></span></span><span class="line"><span class="cl"><span class="sd">            });
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">            if (&#34;${{ steps.plan.outcome }}&#34; == &#34;failure&#34;) {
</span></span></span><span class="line"><span class="cl"><span class="sd">              process.exit(1);
</span></span></span><span class="line"><span class="cl"><span class="sd">            }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Tofu Apply&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">inputs.plan_only == false &amp;&amp; steps.plan.outcome == &#39;success&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">tofu apply -auto-approve &#34;tfplan&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>deploy-orchestrator.yml</code></p>
<p>The main pipeline orchestrates the release by calling the reusable workflow for each stage. The <code>needs:</code> keyword creates a promotion chain, ensuring <code>dev</code> deploys first, followed by <code>test</code>, and finally <code>prod</code>. Each job simply passes the correct <code>environment</code> name to the reusable workflow.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Tofu Deploy Orchestrator&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">push</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">main</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">main</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">permissions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">id-token</span><span class="p">:</span><span class="w"> </span><span class="l">write</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">contents</span><span class="p">:</span><span class="w"> </span><span class="l">read</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pull-requests</span><span class="p">:</span><span class="w"> </span><span class="l">write</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">plan</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Plan for PR&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">github.event_name == &#39;pull_request&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">./.github/workflows/opentofu_workspaces_reusable.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">plan_only</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">deploy-dev</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Deploy to DEV&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">github.event_name == &#39;push&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">./.github/workflows/opentofu_workspaces_reusable.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">deploy-test</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Promote to TEST&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">github.event_name == &#39;push&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">needs</span><span class="p">:</span><span class="w"> </span><span class="l">deploy-dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">./.github/workflows/opentofu_workspaces_reusable.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">deploy-prod</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Promote to PROD&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">github.event_name == &#39;push&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">needs</span><span class="p">:</span><span class="w"> </span><span class="l">deploy-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">./.github/workflows/opentofu_workspaces_reusable.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/multi-environment-terraform/workspaces-merge.png"
	width="2224"
	height="1256"
	srcset="/post/multi-environment-terraform/workspaces-merge_hu_2039a7b8ef108062.png 480w, /post/multi-environment-terraform/workspaces-merge_hu_788b6879609aa46e.png 1024w"
	loading="lazy"
	
		alt="Completed pull request with promotions"
	
	
		class="gallery-image" 
		data-flex-grow="177"
		data-flex-basis="424px"
	
></p>
<h2 id="terragrunt-explicit-stacks"><a href="#terragrunt-explicit-stacks" class="header-anchor"></a>Terragrunt Explicit Stacks
</h2><p>As your application grows, its infrastructure often evolves from a single component into a <strong>stack</strong> of several services. Managing the deployment order and dependencies of a complex stack with plain OpenTofu/Terraform can become difficult.</p>
<p>This is where Terragrunt, a thin wrapper for OpenTofu and Terraform, becomes essential. It excels at managing multi-component applications and keeping your configurations DRY. Specifically, the modern <strong>Explicit Stack</strong> pattern provides a powerful &ldquo;blueprint&rdquo; model to define and generate your entire infrastructure.</p>
<h3 id="pros-2"><a href="#pros-2" class="header-anchor"></a>Pros
</h3><ul>
<li>Define an entire stack once in a <code>terragrunt.stack.hcl</code> blueprint, then easily create copies for <code>dev</code>, <code>test</code>, and <code>prod</code>.</li>
<li>See the complete composition of an environment in a single, clear blueprint file.</li>
<li>Terragrunt builds a deployment graph from your blueprint, automatically ensuring the correct deployment order.</li>
<li>Plan or apply an entire environment with a single command, like <code>terragrunt stack run apply</code>.</li>
</ul>
<h3 id="cons-2"><a href="#cons-2" class="header-anchor"></a>Cons
</h3><ul>
<li>Requires learning the advanced blueprint concepts of <code>unit</code> blocks, <code>values</code>, and the generation process.</li>
<li>Auto-generated files in the <code>.terragrunt-stack</code> directory can make debugging feel less direct than with simpler models.</li>
<li>The required structure (<code>units</code>, <code>stacks</code>) can be overkill for smaller projects.</li>
</ul>
<h3 id="project-structure-2"><a href="#project-structure-2" class="header-anchor"></a>Project Structure
</h3><p>Terragrunt separates your live infrastructure configuration from your reusable modules. Your Terraform modules live in their own versioned Git repositories, while your live infrastructure repository contains the units (<code>wrappers</code>) and stacks (<code>blueprints</code>).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">application</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">root</span><span class="o">.</span><span class="n">hcl</span>              <span class="c1"># Root config (backend, common variables)</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">units</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">├──</span> <span class="n">resource_group</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">terragrunt</span><span class="o">.</span><span class="n">hcl</span>   <span class="c1"># Reusable wrapper for a resource_group module</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">└──</span> <span class="n">storage_account</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>       <span class="err">└──</span> <span class="n">terragrunt</span><span class="o">.</span><span class="n">hcl</span>   <span class="c1"># Reusable wrapper for a storage_account module</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>
</span></span><span class="line"><span class="cl"><span class="err">└──</span> <span class="n">stacks</span><span class="o">/</span>
</span></span><span class="line"><span class="cl">    <span class="err">└──</span> <span class="n">dev</span><span class="o">/</span>
</span></span><span class="line"><span class="cl">    <span class="err">│</span>   <span class="err">└──</span> <span class="n">terragrunt</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">hcl</span> <span class="c1"># THE BLUEPRINT for the &#39;dev&#39; environment</span>
</span></span><span class="line"><span class="cl">    <span class="err">└──</span> <span class="n">prod</span><span class="o">/</span>
</span></span><span class="line"><span class="cl">        <span class="err">└──</span> <span class="n">terragrunt</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">hcl</span> <span class="c1"># THE BLUEPRINT for the &#39;prod&#39; environment</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="configuration-examples-2"><a href="#configuration-examples-2" class="header-anchor"></a>Configuration Examples
</h3><p><code>root.hcl</code></p>
<p>This file, at the top of your repository, defines configurations that are inherited by all other modules, eliminating repetition.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-terraform" data-lang="terraform"><span class="line"><span class="cl"><span class="c1"># Configure the remote state backend ONCE for all modules.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">remote_state</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">backend</span> <span class="o">=</span> <span class="s2">&#34;azurerm&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">generate</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">path</span>      <span class="o">=</span> <span class="s2">&#34;backend.tf&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">if_exists</span> <span class="o">=</span> <span class="s2">&#34;overwrite_terragrunt&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">use_azuread_auth</span>     <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="nx">use_oidc</span>             <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="nx">resource_group_name</span>  <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">storage_account_name</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">container_name</span>       <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">key</span>                  <span class="o">=</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nx">path_relative_to_include</span><span class="p">()</span><span class="si">}</span><span class="s2">/terraform.tfstate&#34;</span><span class="c1"> # e.g. dev/vnet/terraform.tfstate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1"># Generate an Azure provider block for every module
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">generate</span> <span class="s2">&#34;provider&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">path</span>      <span class="o">=</span> <span class="s2">&#34;provider.tf&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">if_exists</span> <span class="o">=</span> <span class="s2">&#34;overwrite_terragrunt&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">contents</span>  <span class="o">=</span> <span class="o">&lt;&lt;EOF</span><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">provider &#34;azurerm&#34; {
</span></span></span><span class="line"><span class="cl"><span class="s">  features {}
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s"></span><span class="o">EOF</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1"># Define common inputs for all modules in this repo
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">inputs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">location</span>    <span class="o">=</span> <span class="s2">&#34;norwayeast&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>units/resource_group/terragrunt.hcl</code></p>
<p>This is a reusable &ldquo;unit template&rdquo; that wraps your Terraform module. The <code>values</code> object is used to access variables passed down from the blueprint.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-terraform" data-lang="terraform"><span class="line"><span class="cl"><span class="nx">include</span> <span class="s2">&#34;root&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">path</span> <span class="o">=</span> <span class="nx">find_in_parent_folders</span><span class="p">(</span><span class="s2">&#34;root.hcl&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">terraform</span> <span class="p">{</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">  # The source URL is in from the blueprint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">source</span> <span class="o">=</span><span class="nb"> values</span><span class="p">.</span><span class="nx">module_source</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1"># The inputs are also passed in from the blueprint&#39;s &#39;values&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">inputs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span>        <span class="o">=</span><span class="nb"> values</span><span class="p">.</span><span class="nx">name</span>
</span></span><span class="line"><span class="cl">  <span class="nx">environment</span> <span class="o">=</span><span class="nb"> values</span><span class="p">.</span><span class="nx">environment</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>units/storage_account/terragrunt.hcl</code></p>
<p>This unit template shows how to define a dependency. The config_path uses a variable that will be provided by the blueprint.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-terraform" data-lang="terraform"><span class="line"><span class="cl"><span class="nx">include</span> <span class="s2">&#34;root&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">path</span> <span class="o">=</span> <span class="nx">find_in_parent_folders</span><span class="p">(</span><span class="s2">&#34;root.hcl&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">terraform</span> <span class="p">{</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">  # The source URL is passed in from the blueprint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">source</span> <span class="o">=</span><span class="nb"> values</span><span class="p">.</span><span class="nx">module_source</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">dependency</span> <span class="s2">&#34;resource_group&#34;</span> <span class="p">{</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">  # The path to the dependency is passed in from the blueprint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">config_path</span>  <span class="o">=</span><span class="nb"> values</span><span class="p">.</span><span class="nx">resource_group_path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">mock_outputs</span> <span class="o">=</span> <span class="p">{</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">    # The mock value is passed in from the blueprint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">rg_name</span> <span class="o">=</span><span class="nb"> values</span><span class="p">.</span><span class="nx">mock_rg_name</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">inputs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span>        <span class="o">=</span><span class="nb"> values</span><span class="p">.</span><span class="nx">name</span>
</span></span><span class="line"><span class="cl">  <span class="nx">environment</span> <span class="o">=</span><span class="nb"> values</span><span class="p">.</span><span class="nx">environment</span>
</span></span><span class="line"><span class="cl">  <span class="nx">rg_name</span>     <span class="o">=</span> <span class="nx">dependency</span><span class="p">.</span><span class="nx">resource_group</span><span class="p">.</span><span class="nx">outputs</span><span class="p">.</span><span class="nx">rg_name</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>stacks/dev/terragrunt.stack.hcl</code></p>
<p>This is the blueprint. It assembles the final environment by pointing to the reusable units and providing the specific values for <code>dev</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-terraform" data-lang="terraform"><span class="line"><span class="cl"><span class="nx">unit</span> <span class="s2">&#34;resource_group&#34;</span> <span class="p">{</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">  # Source points to our reusable Unit Template
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">source</span> <span class="o">=</span> <span class="s2">&#34;../../units/resource_group&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">path</span>   <span class="o">=</span> <span class="s2">&#34;resource_group&#34;</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">  # These &#39;values&#39; are passed as variables to the unit&#39;s terragrunt.hcl
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">values</span> <span class="o">=</span> <span class="p">{</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">    # This points to your versioned Terraform module repository
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">module_source</span> <span class="o">=</span> <span class="s2">&#34;git::git@github.com:your-org/terraform-azurerm-resource-group.git?ref=v1.0.0&#34;</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">    # Module-specific inputs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">name</span>        <span class="o">=</span> <span class="s2">&#34;grunt-dev&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">environment</span> <span class="o">=</span> <span class="s2">&#34;dev&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">unit</span> <span class="s2">&#34;storage_account&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">source</span> <span class="o">=</span> <span class="s2">&#34;../../units/storage_account&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">path</span>   <span class="o">=</span> <span class="s2">&#34;storage_account&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">values</span> <span class="o">=</span> <span class="p">{</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">    # This points to your versioned Terraform module repository
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">module_source</span> <span class="o">=</span> <span class="s2">&#34;git::git@github.com:your-org/terraform-azurerm-storage-account.git?ref=v1.2.0&#34;</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">    # Module-specific inputs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">name</span>        <span class="o">=</span> <span class="s2">&#34;gruntdev932847&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">environment</span> <span class="o">=</span> <span class="s2">&#34;dev&#34;</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">    # We pass the relative path that the dependency
</span></span></span><span class="line"><span class="cl"><span class="c1">    # block in the unit template needs to find the other generated unit.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">resource_group_path</span> <span class="o">=</span> <span class="s2">&#34;../resource_group&#34;</span><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">    # We also pass the mock value to keep the unit template generic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mock_rg_name</span> <span class="o">=</span> <span class="s2">&#34;grunt-dev&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="local-workflow-2"><a href="#local-workflow-2" class="header-anchor"></a>Local Workflow
</h3><p>To deploy the entire <code>dev</code> stack, you run a <code>stack</code> command from the directory containing the blueprint.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Clone repository</span>
</span></span><span class="line"><span class="cl">git clone git@github.com:your-org/application.git
</span></span><span class="line"><span class="cl"><span class="c1"># Navigate to the blueprint&#39;s folder</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> stacks/dev
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># This single command generates, plans, and applies the entire stack in the correct order.</span>
</span></span><span class="line"><span class="cl">terragrunt stack run plan
</span></span><span class="line"><span class="cl">terragrunt stack run apply
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="cicd-pipeline-github-actions-2"><a href="#cicd-pipeline-github-actions-2" class="header-anchor"></a>CI/CD Pipeline (GitHub Actions)
</h3><p>Similar to how we did the OpenTofu pipeline, this uses a reusable workflow to create a promotion path from <code>dev</code> to <code>prod</code>. The entire process is driven by the stack blueprints.</p>
<p><code>reusable-worker.yml</code></p>
<p>This workflow performs the <code>plan</code> or <code>apply</code> for a single environment. It&rsquo;s cloud-agnostic and runs from the repository root.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Terragrunt Reusable Worker&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">workflow_call</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w"> </span><span class="c"># e.g., &#34;dev&#34;, &#34;prod&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">plan_only</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">boolean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">permissions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">id-token</span><span class="p">:</span><span class="w"> </span><span class="l">write</span><span class="w"> </span><span class="c"># For cloud OIDC login</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">contents</span><span class="p">:</span><span class="w"> </span><span class="l">read</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">terragrunt</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Terragrunt ${{ inputs.plan_only &amp;&amp; &#39;Plan&#39; || &#39;Apply&#39; }} on ${{ inputs.environment }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">${{ inputs.environment }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Checkout Code&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/checkout@v4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Setup OpenTofu &amp; Terragrunt&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">gruntwork-io/terragrunt-action@v3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">tg_version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;v0.90.0&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">tofu_version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1.10.6&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># Add your cloud provider login</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Terragrunt Plan&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">inputs.plan_only</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">working-directory</span><span class="p">:</span><span class="w"> </span><span class="l">stacks/${{ inputs.environment }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">terragrunt stack run plan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Terragrunt Apply&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">inputs.plan_only == false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">working-directory</span><span class="p">:</span><span class="w"> </span><span class="l">stacks/${{ inputs.environment }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">terragrunt stack run apply --non-interactive</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>deploy-orchestrator.yml</code></p>
<p>This main pipeline orchestrates the release process by calling the reusable worker for each environment.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Terragrunt Deploy Orchestrator&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">push</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">main]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">main]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s1">&#39;**.hcl&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s1">&#39;.github/workflows/**&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">plan-dev</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Plan Dev for PR&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">github.event_name == &#39;pull_request&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">./.github/workflows/reusable-worker.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">plan_only</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secrets</span><span class="p">:</span><span class="w"> </span><span class="l">inherit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">deploy-dev</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Deploy to DEV&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">github.ref == &#39;refs/heads/main&#39; &amp;&amp; github.event_name == &#39;push&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">./.github/workflows/reusable-worker.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secrets</span><span class="p">:</span><span class="w"> </span><span class="l">inherit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">deploy-prod</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Promote to PROD&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">github.ref == &#39;refs/heads/main&#39; &amp;&amp; github.event_name == &#39;push&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">needs</span><span class="p">:</span><span class="w"> </span><span class="l">deploy-dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">./.github/workflows/reusable-worker.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secrets</span><span class="p">:</span><span class="w"> </span><span class="l">inherit</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/multi-environment-terraform/grunt-stacks-merge.png"
	width="2312"
	height="1128"
	srcset="/post/multi-environment-terraform/grunt-stacks-merge_hu_fd36ac839c3eacd8.png 480w, /post/multi-environment-terraform/grunt-stacks-merge_hu_6ad239cc4ed6cf6.png 1024w"
	loading="lazy"
	
		alt="Pull request merge with approvals"
	
	
		class="gallery-image" 
		data-flex-grow="204"
		data-flex-basis="491px"
	
></p>
<h2 id="conclusion"><a href="#conclusion" class="header-anchor"></a>Conclusion
</h2><p>There is no single <strong>best</strong> solution, only the right one for your project&rsquo;s current scale and complexity.</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: center">Feature</th>
          <th style="text-align: center">Isolated Folders</th>
          <th style="text-align: center">OpenTofu Workspaces</th>
          <th style="text-align: center">Terragrunt Explicit Stacks</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">Simple to Start</td>
          <td style="text-align: center">✅</td>
          <td style="text-align: center">✅</td>
          <td style="text-align: center">🟡</td>
      </tr>
      <tr>
          <td style="text-align: center">DRY (No Repetition)</td>
          <td style="text-align: center">❌</td>
          <td style="text-align: center">✅</td>
          <td style="text-align: center">✅</td>
      </tr>
      <tr>
          <td style="text-align: center">Strong Code Isolation</td>
          <td style="text-align: center">✅</td>
          <td style="text-align: center">🟡</td>
          <td style="text-align: center">✅</td>
      </tr>
      <tr>
          <td style="text-align: center">Dependency Management</td>
          <td style="text-align: center">❌</td>
          <td style="text-align: center">❌</td>
          <td style="text-align: center">✅</td>
      </tr>
      <tr>
          <td style="text-align: center">Advanced Blueprints</td>
          <td style="text-align: center">❌</td>
          <td style="text-align: center">❌</td>
          <td style="text-align: center">✅</td>
      </tr>
      <tr>
          <td style="text-align: center">Scales for Complex Stacks</td>
          <td style="text-align: center">❌</td>
          <td style="text-align: center">🟡</td>
          <td style="text-align: center">✅</td>
      </tr>
  </tbody>
</table></div>

  <blockquote>
    <p><strong>Note</strong>: The GitHub Actions workflows in this article are robust foundations. I encourage you to adapt the triggers, promotion rules, and cloud provider steps to fit your team&rsquo;s specific needs and policies.</p>
  </blockquote>
<h2 id="resources--links"><a href="#resources--links" class="header-anchor"></a>Resources &amp; Links
</h2><p>For more detailed information on stuff used in this article, please refer to the official documentation.</p>
<ul>
<li><a class="link" href="https://opentofu.org/docs/language/state/workspaces/"  target="_blank" rel="noopener"
    >OpenTofu Workspaces</a></li>
<li><a class="link" href="https://terragrunt.gruntwork.io/docs/features/stacks/"  target="_blank" rel="noopener"
    >Terragrunt Explicit Stacks</a>
<ul>
<li><a class="link" href="https://github.com/gruntwork-io/terragrunt-infrastructure-catalog-example/tree/main/examples/terragrunt/stacks"  target="_blank" rel="noopener"
    >Configuration Examples</a></li>
</ul>
</li>
<li><a class="link" href="https://docs.github.com/en/actions"  target="_blank" rel="noopener"
    >GitHub Actions</a></li>
</ul>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/terraform/">Terraform</a>
        
            <a href="/tags/opentofu/">OpenTofu</a>
        
            <a href="/tags/terragrunt/">Terragrunt</a>
        
            <a href="/tags/github-actions/">GitHub Actions</a>
        
            <a href="/tags/iac/">IaC</a>
        
    </section>


    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/post/solve-terraform-drift/">
        
        

        <div class="article-details">
            <h2 class="article-title">Solve Terraform Drift</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/post/azure-terraform-github-actions-oidc/">
        
        

        <div class="article-details">
            <h2 class="article-title">Eliminate Secrets From Your Terraform Azure Backend</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/post/hugo-site-azure/">
        
        

        <div class="article-details">
            <h2 class="article-title">Build a Hugo Website on Azure</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/post/develop-terraform-modules/">
        
        

        <div class="article-details">
            <h2 class="article-title">Develop Terraform Modules</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/post/genai-certification-study/">
        
        

        <div class="article-details">
            <h2 class="article-title">Study With Generative AI</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 Vetle&#39;s Tech Chronicles
    </section>
    
    <section class="powerby">
        
            All opinions are my own. <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.31.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.e37a1c77e9f793cd8619172a944d78c1066956c7d5cd59e9bd51bd3e348898ea.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
